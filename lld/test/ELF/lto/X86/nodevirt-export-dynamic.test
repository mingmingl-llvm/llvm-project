
; RUN: rm -rf %t && mkdir %t && cd %t

; Generate unsplit module with summary for ThinLTO index-based WPD.
; RUN: opt -thinlto-bc -thinlto-split-lto-unit=false -o summary.o %s

; RUN: llvm-dis -o - summary.o | FileCheck %s --check-prefix=DIS

; DIS: gv: (name: "_ZTI7Derived") ; guid = 7771837567748150594
; DIS: gv: (name: "_ZTV7Derived") ; guid = 13870436605473471591


;; Index based WPD
; RUN: ld.lld summary.o -o tmp -save-temps --lto-whole-program-visibility \
; RUN:   -mllvm -pass-remarks=. \
; RUN:   --export-dynamic-symbol=_ZTV7Derived 2>&1 | FileCheck %s --check-prefix=REMARK

; REMARK: asdfgh
; REMARK: single-impl: devirtualized a call to _ZN8DerivedN5printEv

; ModuleID = 'main.o'
source_filename = "main.cc"
target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

$_ZN8DerivedNC2Ev = comdat any

$_ZN4Base8dispatchEv = comdat any

$_ZN7DerivedC2Ev = comdat any

$_ZN8DerivedN5printEv = comdat any

$_ZN4BaseC2Ev = comdat any

$_ZTV8DerivedN = comdat any

$_ZTI8DerivedN = comdat any

$_ZTS8DerivedN = comdat any

@_ZTV8DerivedN = linkonce_odr hidden unnamed_addr constant { [3 x ptr] } { [3 x ptr] [ptr null, ptr @_ZTI8DerivedN, ptr @_ZN8DerivedN5printEv] }, comdat, align 8, !type !0, !type !1, !type !2, !type !3, !type !4, !type !5, !vcall_visibility !6
@_ZTI8DerivedN = linkonce_odr hidden constant { ptr, ptr, ptr } { ptr getelementptr inbounds (ptr, ptr @_ZTVN10__cxxabiv120__si_class_type_infoE, i64 2), ptr @_ZTS8DerivedN, ptr @_ZTI7Derived }, comdat, align 8
@_ZTVN10__cxxabiv120__si_class_type_infoE = external global [0 x ptr]
@_ZTS8DerivedN = linkonce_odr hidden constant [10 x i8] c"8DerivedN\00", comdat, align 1
@_ZTI7Derived = external constant ptr
@_ZTV7Derived = external unnamed_addr constant { [3 x ptr] }, align 8
@_ZTV4Base = external unnamed_addr constant { [3 x ptr] }, align 8
@.str = private unnamed_addr constant [10 x i8] c"DerivedN\0A\00", align 1

; Function Attrs: mustprogress noinline optnone uwtable
define hidden noundef ptr @_Z6getPtri(i32 noundef %x) #0 !dbg !18 {
entry:
  %x.addr = alloca i32, align 4
  store i32 %x, ptr %x.addr, align 4
  %call = call noalias noundef nonnull ptr @_Znwm(i64 noundef 8) #9, !dbg !21
  call void @llvm.memset.p0.i64(ptr align 8 %call, i8 0, i64 8, i1 false), !dbg !22
  call void @_ZN8DerivedNC2Ev(ptr noundef nonnull align 8 dereferenceable(8) %call) #10, !dbg !22
  ret ptr %call, !dbg !23
}

; Function Attrs: nobuiltin allocsize(0)
declare noundef nonnull ptr @_Znwm(i64 noundef) #1

; Function Attrs: nocallback nofree nounwind willreturn memory(argmem: write)
declare void @llvm.memset.p0.i64(ptr writeonly captures(none), i8, i64, i1 immarg) #2

; Function Attrs: mustprogress noinline nounwind optnone uwtable
define linkonce_odr hidden void @_ZN8DerivedNC2Ev(ptr noundef nonnull align 8 dereferenceable(8) %this) unnamed_addr #3 comdat align 2 !dbg !24 {
entry:
  %this.addr = alloca ptr, align 8
  store ptr %this, ptr %this.addr, align 8
  %this1 = load ptr, ptr %this.addr, align 8
  call void @_ZN7DerivedC2Ev(ptr noundef nonnull align 8 dereferenceable(8) %this1) #10, !dbg !25
  store ptr getelementptr inbounds inrange(-16, 8) ({ [3 x ptr] }, ptr @_ZTV8DerivedN, i32 0, i32 0, i32 2), ptr %this1, align 8, !dbg !25
  ret void, !dbg !25
}

; Function Attrs: mustprogress noinline norecurse optnone uwtable
define hidden noundef i32 @main() #4 !dbg !26 {
entry:
  %retval = alloca i32, align 4
  %b = alloca ptr, align 8
  %a = alloca ptr, align 8
  store i32 0, ptr %retval, align 4
  %call = call noundef ptr @_Z6createi(i32 noundef 201), !dbg !27
  store ptr %call, ptr %b, align 8, !dbg !28
  %0 = load ptr, ptr %b, align 8, !dbg !29
  call void @_ZN4Base8dispatchEv(ptr noundef nonnull align 8 dereferenceable(8) %0), !dbg !30
  %1 = load ptr, ptr %b, align 8, !dbg !31
  %isnull = icmp eq ptr %1, null, !dbg !32
  br i1 %isnull, label %delete.end, label %delete.notnull, !dbg !32

delete.notnull:                                   ; preds = %entry
  call void @_ZdlPvm(ptr noundef %1, i64 noundef 8) #11, !dbg !32
  br label %delete.end, !dbg !32

delete.end:                                       ; preds = %delete.notnull, %entry
  %call1 = call noundef ptr @_Z6getPtri(i32 noundef 202), !dbg !33
  store ptr %call1, ptr %a, align 8, !dbg !34
  %2 = load ptr, ptr %a, align 8, !dbg !35
  call void @_ZN4Base8dispatchEv(ptr noundef nonnull align 8 dereferenceable(8) %2), !dbg !36
  %3 = load ptr, ptr %a, align 8, !dbg !37
  %isnull2 = icmp eq ptr %3, null, !dbg !38
  br i1 %isnull2, label %delete.end4, label %delete.notnull3, !dbg !38

delete.notnull3:                                  ; preds = %delete.end
  call void @_ZdlPvm(ptr noundef %3, i64 noundef 8) #11, !dbg !38
  br label %delete.end4, !dbg !38

delete.end4:                                      ; preds = %delete.notnull3, %delete.end
  ret i32 0, !dbg !39
}

declare noundef ptr @_Z6createi(i32 noundef) #5

; Function Attrs: mustprogress noinline optnone uwtable
define linkonce_odr hidden void @_ZN4Base8dispatchEv(ptr noundef nonnull align 8 dereferenceable(8) %this) #0 comdat align 2 !dbg !40 !type !42 {
entry:
  %this.addr = alloca ptr, align 8
  store ptr %this, ptr %this.addr, align 8
  %this1 = load ptr, ptr %this.addr, align 8
  %vtable = load ptr, ptr %this1, align 8, !dbg !43
  %0 = call i1 @llvm.type.test(ptr %vtable, metadata !"_ZTS4Base"), !dbg !43
  call void @llvm.assume(i1 %0), !dbg !43
  %vfn = getelementptr inbounds ptr, ptr %vtable, i64 0, !dbg !43
  %1 = load ptr, ptr %vfn, align 8, !dbg !43
  call void %1(ptr noundef nonnull align 8 dereferenceable(8) %this1), !dbg !43
  ret void, !dbg !44
}

; Function Attrs: nobuiltin nounwind
declare void @_ZdlPvm(ptr noundef, i64 noundef) #6

; Function Attrs: mustprogress noinline nounwind optnone uwtable
define linkonce_odr hidden void @_ZN7DerivedC2Ev(ptr noundef nonnull align 8 dereferenceable(8) %this) unnamed_addr #3 comdat align 2 !dbg !45 {
entry:
  %this.addr = alloca ptr, align 8
  store ptr %this, ptr %this.addr, align 8
  %this1 = load ptr, ptr %this.addr, align 8
  call void @_ZN4BaseC2Ev(ptr noundef nonnull align 8 dereferenceable(8) %this1) #10, !dbg !46
  store ptr getelementptr inbounds inrange(-16, 8) ({ [3 x ptr] }, ptr @_ZTV7Derived, i32 0, i32 0, i32 2), ptr %this1, align 8, !dbg !46
  ret void, !dbg !46
}

; Function Attrs: mustprogress noinline optnone uwtable
define linkonce_odr hidden void @_ZN8DerivedN5printEv(ptr noundef nonnull align 8 dereferenceable(8) %this) unnamed_addr #0 comdat align 2 !dbg !47 {
entry:
  %this.addr = alloca ptr, align 8
  store ptr %this, ptr %this.addr, align 8
  %this1 = load ptr, ptr %this.addr, align 8
  %call = call i32 (ptr, ...) @printf(ptr noundef @.str), !dbg !48
  ret void, !dbg !49
}

; Function Attrs: mustprogress noinline nounwind optnone uwtable
define linkonce_odr hidden void @_ZN4BaseC2Ev(ptr noundef nonnull align 8 dereferenceable(8) %this) unnamed_addr #3 comdat align 2 !dbg !50 {
entry:
  %this.addr = alloca ptr, align 8
  store ptr %this, ptr %this.addr, align 8
  %this1 = load ptr, ptr %this.addr, align 8
  store ptr getelementptr inbounds inrange(-16, 8) ({ [3 x ptr] }, ptr @_ZTV4Base, i32 0, i32 0, i32 2), ptr %this1, align 8, !dbg !51
  ret void, !dbg !51
}

declare i32 @printf(ptr noundef, ...) #5

; Function Attrs: nocallback nofree nosync nounwind speculatable willreturn memory(none)
declare i1 @llvm.type.test(ptr, metadata) #7

; Function Attrs: nocallback nofree nosync nounwind willreturn memory(inaccessiblemem: write)
declare void @llvm.assume(i1 noundef) #8

attributes #0 = { mustprogress noinline optnone uwtable "frame-pointer"="all" "min-legal-vector-width"="0" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cmov,+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" }
attributes #1 = { nobuiltin allocsize(0) "frame-pointer"="all" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cmov,+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" }
attributes #2 = { nocallback nofree nounwind willreturn memory(argmem: write) }
attributes #3 = { mustprogress noinline nounwind optnone uwtable "frame-pointer"="all" "min-legal-vector-width"="0" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cmov,+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" }
attributes #4 = { mustprogress noinline norecurse optnone uwtable "frame-pointer"="all" "min-legal-vector-width"="0" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cmov,+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" }
attributes #5 = { "frame-pointer"="all" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cmov,+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" }
attributes #6 = { nobuiltin nounwind "frame-pointer"="all" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cmov,+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" }
attributes #7 = { nocallback nofree nosync nounwind speculatable willreturn memory(none) }
attributes #8 = { nocallback nofree nosync nounwind willreturn memory(inaccessiblemem: write) }
attributes #9 = { builtin allocsize(0) }
attributes #10 = { nounwind }
attributes #11 = { builtin nounwind }

!llvm.dbg.cu = !{!7}
!llvm.module.flags = !{!9, !10, !11, !12, !13, !14, !15}
!llvm.ident = !{!17}

!0 = !{i64 16, !"_ZTS4Base"}
!1 = !{i64 16, !"_ZTSM4BaseFvvE.virtual"}
!2 = !{i64 16, !"_ZTS7Derived"}
!3 = !{i64 16, !"_ZTSM7DerivedFvvE.virtual"}
!4 = !{i64 16, !"_ZTS8DerivedN"}
!5 = !{i64 16, !"_ZTSM8DerivedNFvvE.virtual"}
!6 = !{i64 1}
!7 = distinct !DICompileUnit(language: DW_LANG_C_plus_plus_14, file: !8, producer: "clang version 21.0.0git (https://github.com/mingmingl-llvm/llvm-project.git e9fc7683a54d9e5233cff5d016d6f2cdcaf2b2c3)", isOptimized: true, runtimeVersion: 0, emissionKind: NoDebug, splitDebugInlining: false, nameTableKind: None)
!8 = !DIFile(filename: "main.cc", directory: "/usr/local/google/home/mingmingl/llvm-import-dec/llvm-project/build")
!9 = !{i32 2, !"Debug Info Version", i32 3}
!10 = !{i32 1, !"wchar_size", i32 4}
!11 = !{i32 1, !"Virtual Function Elim", i32 0}
!12 = !{i32 8, !"PIC Level", i32 2}
!13 = !{i32 7, !"PIE Level", i32 2}
!14 = !{i32 7, !"uwtable", i32 2}
!15 = !{i32 7, !"frame-pointer", i32 2}
;!16 = !{i32 1, !"EnableSplitLTOUnit", i32 0}
!17 = !{!"clang version 21.0.0git (https://github.com/mingmingl-llvm/llvm-project.git e9fc7683a54d9e5233cff5d016d6f2cdcaf2b2c3)"}
!18 = distinct !DISubprogram(name: "getPtr", scope: !8, file: !8, line: 13, type: !19, scopeLine: 13, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !7)
!19 = !DISubroutineType(types: !20)
!20 = !{}
!21 = !DILocation(line: 14, column: 10, scope: !18)
!22 = !DILocation(line: 14, column: 14, scope: !18)
!23 = !DILocation(line: 14, column: 3, scope: !18)
!24 = distinct !DISubprogram(name: "DerivedN", scope: !8, file: !8, line: 6, type: !19, scopeLine: 6, flags: DIFlagArtificial | DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !7)
!25 = !DILocation(line: 6, column: 7, scope: !24)
!26 = distinct !DISubprogram(name: "main", scope: !8, file: !8, line: 18, type: !19, scopeLine: 18, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !7)
!27 = !DILocation(line: 19, column: 37, scope: !26)
!28 = !DILocation(line: 19, column: 11, scope: !26)
!29 = !DILocation(line: 20, column: 3, scope: !26)
!30 = !DILocation(line: 20, column: 6, scope: !26)
!31 = !DILocation(line: 21, column: 10, scope: !26)
!32 = !DILocation(line: 21, column: 3, scope: !26)
!33 = !DILocation(line: 23, column: 38, scope: !26)
!34 = !DILocation(line: 23, column: 12, scope: !26)
!35 = !DILocation(line: 24, column: 3, scope: !26)
!36 = !DILocation(line: 24, column: 6, scope: !26)
!37 = !DILocation(line: 25, column: 10, scope: !26)
!38 = !DILocation(line: 25, column: 3, scope: !26)
!39 = !DILocation(line: 26, column: 3, scope: !26)
!40 = distinct !DISubprogram(name: "dispatch", scope: !41, file: !41, line: 6, type: !19, scopeLine: 6, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !7)
!41 = !DIFile(filename: "./lib.h", directory: "/usr/local/google/home/mingmingl/llvm-import-dec/llvm-project/build")
!42 = !{i64 0, !"_ZTSM4BaseFvvE"}
!43 = !DILocation(line: 7, column: 9, scope: !40)
!44 = !DILocation(line: 8, column: 1, scope: !40)
!45 = distinct !DISubprogram(name: "Derived", scope: !41, file: !41, line: 13, type: !19, scopeLine: 13, flags: DIFlagArtificial | DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !7)
!46 = !DILocation(line: 13, column: 7, scope: !45)
!47 = distinct !DISubprogram(name: "print", scope: !8, file: !8, line: 8, type: !19, scopeLine: 8, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !7)
!48 = !DILocation(line: 9, column: 5, scope: !47)
!49 = !DILocation(line: 10, column: 3, scope: !47)
!50 = distinct !DISubprogram(name: "Base", scope: !41, file: !41, line: 3, type: !19, scopeLine: 3, flags: DIFlagArtificial | DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !7)
!51 = !DILocation(line: 3, column: 7, scope: !50)
